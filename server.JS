const { OpenAI } = require("openai");
const Chat = require("./models/chat");
require("dotenv").config();

const openai = new OpenAI({
  apiKey: process.env.OPENROUTER_API_KEY,
  baseURL: "https://openrouter.ai/api/v1",
  defaultHeaders: {
    "HTTP-Referer": "http://localhost:3000",
    "X-Title": "MyTestBot",
  },
});

const handleChat = async (req, res) => {
  const { message: userMessage, userId } = req.body;

  if (!userMessage || !userId) {
    return res.status(400).json({ error: "ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆÙ…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" });
  }

  try {
    // ğŸ§  Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ§Ù‚ Ù‚Ø¯ÙŠÙ…
    const messages = [
      { role: "system", content: "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙŠØªØ­Ø¯Ø« Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ©." },
      { role: "user", content: userMessage },
    ];

    // ğŸ¤– Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡
    const chatCompletion = await openai.chat.completions.create({
      model: "openai/gpt-3.5-turbo",
      messages,
    });

    const reply = chatCompletion.choices[0].message.content;

    // ğŸ“ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ø±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ­ØªÙØ¸ Ø¨Ø§Ù„Ø´Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    await Chat.create({ userId, message: userMessage, reply });

    // â¬…ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† history
    res.json({ reply });

  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙØ¹Ù„ÙŠ:", error.response?.data || error.message);
    res.status(500).json({
      error: "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ OpenRouter API",
      details: error.message,
    });
  }
};

module.exports = { handleChat };
